<?php

/*
 * Bryce Schmisseur and Hermes Mimini
 * Job Match Application
 * UserDataService.php
 *
 */

namespace App\data;

use App\model\User;
use App\model\Job;
use App\model\Education;
use App\model\UserCredential;
use App\model\UserInformation;

session_start();

Class UserDataService implements DataServiceInterface {
    
    private $connection;
    
    public function __construct()
    {
        $database = new Database();
        $this->connection = $database->getConnection();
    }

    public function viewByID(int $id)
    { 
        $indexJobs = 0;
        $indexEducation = 0; 
        
        $sql_query_user = "SELECT * FROM USER WHERE ID = {$id}";
        $sql_query_user_cred = "SELECT * FROM USER_CREDENTIAL WHERE USER_ID = {$id}";
        $sql_query_user_info = "SELECT * FROM USER_INFO WHERE USER_ID = {$id}";
        $sql_query_jobs = "SELECT * FROM JOB WHERE USER_ID = {$id}";
        $sql_query_education = "SELECT * FROM EDUCATION WHERE USER_ID = {$id}";
        
        $results_user = mysqli_query($this->connection, $sql_query_user);
        $results_user_cred = mysqli_query($this->connection, $sql_query_user_cred);
        $results_user_info = mysqli_query($this->connection, $sql_query_user_info);
        $results_job = mysqli_query($this->connection, $sql_query_jobs);
        $resutls_education = mysqli_query($this->connection, $sql_query_education);
        
        $rowUser = $results_user->fetch_assoc();
        $rowUserCred = $results_user_cred->fetch_assoc();
        $rowUserInfo = $results_user_info->fetch_assoc();
        
        $firstName = $rowUser['FIRSTNAME'];
        $lastName = $rowUser['LASTNAME'];
        $email = $rowUser['EMAIL'];
        $phoneNumber = $rowUser['PHONENUMBER'];
        $userRole = $rowUser['USER_ROLE'];
        $active = $rowUser['ACTIVE'];
        $userName = $rowUserCred['USERNAME'];
        $password = $rowUserCred['PASSWORD'];
        $bio = $rowUserInfo['BIO'];
        $jobs = array();
        $educationHistory = array();
        
        while($rowJobs = $results_job->fetch_assoc())
        {
            $jobId = $rowJobs['ID'];
            $jobTitle = $rowJobs['JOB_TITLE'];
            $company = $rowJobs['JOB_COMPANY'];
            $startDate = $rowJobs['START_DATE'];
            $endDate = $rowJobs['END_DATE'];
            $jobDescription = $rowJobs['DESCRIPTION'];
            
            $currentJob = new Job($jobId, $jobTitle, $company, $startDate, $endDate, $jobDescription);
            $jobs[$indexJobs] = $currentJob;
            $indexJobs++; 
        }
        
        while($rowEducation = $resutls_education->fetch_assoc())
        {
            $educationId = $rowEducation['ID'];
            $schoolName = $rowEducation['NAME'];
            $degree = $rowEducation['DEGREE'];
            $field = $rowEducation['FIELD'];
            $educationStartDate = $rowEducation['START_DATE'];
            $educationEndDate = $rowEducation['END_DATE'];
            $educationDescription = $rowEducation['DESCRIPTION'];
            
            $currentEducation = new Education($educationId, $schoolName, $degree, $field, $educationStartDate, $educationEndDate, $educationDescription);
            $educationHistory[$indexEducation] = $currentEducation;
            $indexEducation++;
        }
        
        $currentUserCreds = new UserCredential($userName, $password);
        $currentUserInfo = new UserInformation($bio, $jobs, $educationHistory);
        $currentUser = new User($id, $firstName, $lastName, $email, $phoneNumber, $userRole, $active, $currentUserCreds, $currentUserInfo);
        
        return $currentUser;
    }

    public function create(User $user)
    {
        $sqlStatement = "INSERT INTO `user` (`ID`, `FIRSTNAME`, `LASTNAME`, `EMAIL`, `PHONENUMBER`, `USER_ROLE`, `ACTIVE`) 
                         VALUES (NULL, '{$user->getFirstName()}', '{$user->getLastName()}', '{$user->getEmail()}', 
                         '{$user->getPhoneNumber()}', '{$user->getUserRole()}', '{$user->isActive()}');";
        
        $result = $this->connection->query($sqlStatement);
        
        $userID = mysqli_insert_id($this->connection);
        
        $user->setIdNum($userID);
        
        if($result == false)
        {
            return $result;
        }
        
        else
        {
            $sqlStatement = "INSERT INTO `user_credential` (`USERNAME`, `PASSWORD`, `USER_ID`) VALUES 
                        ('{$user->getUserCredential()->getUserName()}', '{$user->getUserCredential()->getPassword()}', 
                        '{$user->getIdNum()}');";
            
            $result = $this->connection->query($sqlStatement);
            
            return $result;
        }
        
    }

    public function update(User $user)
    {
        $numRowsAffected = 0;
        
        $sqlUser = "UPDATE `USER` SET `FIRSTNAME` = '{$user->getFirstName}', `LASTNAME` = '{$user->getLastName()}', 
                    `EMAIL` = '{$user->getEmail()}', `PHONENUMBER` = '{$user->getPhoneNumber()}', `USER_ROLE` = 
                    '{$user->getUserRole()}', `ACTIVE` = '{$user->isActive()}' WHERE `USER`.`ID` = {$user->getIdNum()};";
        $sqlUserCreds = "UPDATE `USER_CREDENTIAL` SET `USERNAME` = '{$user->getUserCredential()->getUserName()}', 
                        `PASSWORD` = '{$user->getUserCredential()->getPassword()}' WHERE 
                        `USER_CREDENTIAL`.`USER_ID` = {$user->getIdNum()};";
        $sqlUserInfo = "UPDATE `USER_INFO` SET `BIO` = '{$user->getUserInformation()->getBio()}' WHERE 
                        `USER_INFO`.`USER_ID` = {$user->getIdNum()};";
        
        $this->connection->query($sqlUser);
        $numRowsAffected += $this->connection->affected_rows;
        $this->connection->query($sqlUserCreds);
        $numRowsAffected += $this->connection->affected_rows;
        $this->connection->query($sqlUserInfo);
        $numRowsAffected += $this->connection->affected_rows;
        
        foreach($user->getUserInformation()->getJobs() as Job $currentJob)
        {
            $sqlJob = "UPDATE `JOB` SET `JOB_TITLE` = '{$currentJob->get}', `JOB_COMPANY` = 'GCUs', `START_DATE` = '2020-02-02 00:00:00', `END_DATE` = '2020-02-08 00:00:00', `DESCRIPTION` = 'funs' WHERE `JOB`.`ID` = 1;";
        }
        
        return $numRowsAffected;
    }

    public function delete(int $id)
    {
        
    }

    public function viewAll()
    {
        $users = array(); 
        $indexUser = 0; 
        
        $sqlQuery = "SELECT * FROM USER";
        $resutls = mysqli_query($this->connection, $sqlQuery);
        
        while($row = $resutls->fetch_assoc())
        {
            $id = $row['ID'];
            
            $currentUser = $this->viewByID($id);
            
            $users[$indexUser] = $currentUser;
            $indexUser++;
        }
        
        return $users;
    }



    
}